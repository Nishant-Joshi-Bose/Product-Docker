<!DOCTYPE html>
<html lang="en">

	<!--#####################################################################-->
	<!--################################################################ Head-->
	<!--#####################################################################-->
	<head>
		<meta charset="utf-8" />
		<title>PSoC/Capsense/Lightbar</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />

		<!--#################################################################-->
		<!--########################################################## Style -->
		<!--#################################################################-->
		<style type="text/css">
			fieldset { border:2px solid grey; }
			legend {
			  padding: 0.2em 0.5em;
			  border:none;
			  color:grey;
			  font-size:100%;
			  text-align:right;
			  }

			form  { display: table;		 }
			p	  { display: table-row;  }
			label { display: table-cell;font-weight:bold; }
			input { display: table-cell; }

			body {
				background-color: #789; margin: 0;
				padding: 0; font: 14px Helvetica, Arial, sans-serif;
			}
			div.content {
				width: 900px; margin: 2em auto; padding: 20px 50px;
				background-color: #fff; border-radius: 1em;
			}
			#telemetry_list {
				border: 2px solid #fec; border-radius: 1em;
				height: 10em; overflow: scroll; padding: 0.5em 1em;
			}
			a:link, a:visited { color: #69c; text-decoration: none; }
			@media (max-width: 700px) {
				body { background-color: #fff; }
				div.content {
					width: auto; margin: 0 auto; border-radius: 0;
					padding: 1em;
				}
			}
			/* Style the tab */
			div.tab {
			    overflow: hidden;
			    border: 1px solid #ccc;
			    background-color: #f1f1f1;
			}

			/* Style the buttons inside the tab */
			div.tab button {
			    background-color: inherit;
			    float: left;
			    border: none;
			    outline: none;
			    cursor: pointer;
			    padding: 14px 16px;
			    transition: 0.3s;
			    font-size: 17px;
			}

			/* Change background color of buttons on hover */
			div.tab button:hover {
			    background-color: #ddd;
			}

			/* Create an active/current tablink class */
			div.tab button.active {
			    background-color: #ccc;
			}

			/* Style the tab content */
			.tabcontent {
			    display: none;
			    padding: 6px 12px;
			    border: 1px solid #ccc;
			    border-top: none;
			}

		</style>

		<!--#################################################################-->
		<!--########################################################## Script-->
		<!--#################################################################-->
		<script language="javascript" type="text/javascript">

			//------------------------------------------------------------------
			//----------------------------------------------------------- consts
			//------------------------------------------------------------------
			const WEB_SOCKET_URL	= 'ws://' + location.host + '/ws'
			const MAX_FRAME_RATE	= 100 ;
			const MAX_LED_INTENSITY = 4095;
			const NUMBER_OF_WHITE	= 13;
			const BUTTON_RADIUS		= 35;

			//------------------------------------------------------------------
			//-------------------------------------------------------- variables
			//------------------------------------------------------------------
			var ws				 = new WebSocket(WEB_SOCKET_URL );
			var animation_worker = null;
			var button_canvas	 = null; 
			var button_context	 = null;
			var button_font		 = null;
				
			var pattern_array = [];
			var pattern_array_selected = [];
			var animation_array = [];
			var pattern_obj_array = [] // used in view/edit animation for loading patterns for individual animation

			//pattern format should be used to validate animations created from tool 
			//and accordingly components should be displayed on page
			//in future, when there are multiple types of lightbar page
			//will have option to create and play patterns for different version of
			//lightbar
			var pattern_format = "";

			ws.onopen  = function(ev) { console.log(ev); };
			ws.onerror = function(ev) { console.log(ev); };
			ws.onclose = function(ev) { console.log(ev); };

			//------------------------------------------------------------------
			//----------------------------------------------------- ws.onmessage
			//------------------------------------------------------------------
			ws.onmessage = function(ev) {
				//messageElem = document.getElementById('telemetry_list');

                                var opt = document.createElement('option');

				console.log(ev);
				var div = document.createElement('div');

				if (ev.data[0] == '{')
				{
 					try{
						var telemetry = JSON.parse(ev.data);
					}
					catch (err) {
						console.log(err);
					}

					switch (telemetry.event) {
						case 'button'	  : parse_slider_button(telemetry);
											break;
						case 'push button': parse_push_button(telemetry);
											break;
						case 'animation list': 	parse_animation_list(telemetry);
								      	break;
						case 'action error'  : parse_action_error(telemetry);
									break;
						case 'action success': parse_action_success(telemetry);
									break;
						case 'Configuration' : parse_lightbar_config(telemetry);
						default			  : break; // nothing to do
					}// switch on the telemetry
				}

				//div.innerHTML = get_time_ms() + " " + ev.data;
				//messageElem.insertBefore(div, messageElem.childNodes[0]);
			};// ws.onmessage
			if (!window.console) { window.console = { log: function() {} } };


			//------------------------------------------------------------------
			//--------------------------------------------------------- sleep_ms
			//------------------------------------------------------------------
			function sleep_ms(milliseconds) {
				var start = new Date().getTime();
				for (var i = 0; i < 1e7; i++) {
					if ((new Date().getTime() - start) > milliseconds){
						break;
					}
				}
			}// sleep_ms

			//------------------------------------------------------------------
			//---------------------- javascript animation and LED strip commands
			//------------------------------------------------------------------
			function initialize_javascript_animation() {
				if (animation_worker == null){
					animation_worker = new Worker('animation.js');
					animation_worker.onmessage = function (event) {
						console.log("animation_worker event: " + event.data);
						if (event.data == 'WORKER UNINITIALIZED'){
							animation_worker.terminate();
							animation_worker = null;
						}
					};
				}

				animation_worker.postMessage({'cmd': 'init', 'msg': WEB_SOCKET_URL});
			}// initialize_javascript_animation

			function uninitialize_javascript_animation() {
				animation_worker.postMessage({'cmd': 'uninit'});
			}// uninitialize_javascript_animation

			function start_javascript_animation(frame_rate,anim) {
				animation_worker.postMessage({'cmd': 'start', 'msg': frame_rate, 'animation': anim});
				//animation_worker.postMessage({'cmd': 'start', 'msg': frame_rate});
			}// start_javascript_animation

			function stop_javascript_animation() {
				animation_worker.postMessage({'cmd': 'stop'});
			}// stop_javascript_animation

			function set_javascript_animation_frame_rate(frame_rate) {
				animation_worker.postMessage({'cmd': 'set frame rate', 'msg': frame_rate});
			}// set_javascript_animation_frame_rate

			function clear_led_strip() {
                var led_array = pattern_format.split('-');

                for (var i = 0;i < led_array.length;i++)
                    led_array[i] = 0;
				//animation_worker.postMessage({'cmd': 'clear led strip'});
				animation_worker.postMessage({'cmd': 'set led strip', 'leds': led_array});
			}// clear_led_strip

			//function set_led_strip(left, right, whites) {
			function set_led_strip(leds) {
				animation_worker.postMessage({'cmd': 'set led strip', 'leds': leds});
			}// set_led_strip

			//------------------------------------------------------------------
			//--------------------------------------- select_intrinsic_animation
			//------------------------------------------------------------------
			function select_intrinsic_animation(animation) {
				clear_led_strip();
				ws.send ('{"event":"cmd","type":"animation","action":"' + animation + '"}')
			};// select_intrinsic_animation

			//------------------------------------------------------------------
			//--------------------------------------------------------- add_zero
			//------------------------------------------------------------------
			function add_zero(x,n) {
				while (x.toString().length < n) {
					x = "0" + x;
				}

				return x;
			};// add_zero

			//------------------------------------------------------------------
			//------------------------------------------------------ get_time_ms
			//------------------------------------------------------------------
			function get_time_ms () {
				var d  = new Date();
				var h  = add_zero(d.getHours()		 , 2);
				var m  = add_zero(d.getMinutes()	 , 2);
				var s  = add_zero(d.getSeconds()	 , 2);
				var ms = add_zero(d.getMilliseconds(), 3);
				return h + ":" + m + ":" + s + ":" + ms;
			};// get_time_ms

			//------------------------------------------------------------------
			//---------------------------------------------- parse_slider_button
			//------------------------------------------------------------------
			function parse_slider_button(telemetry){

			}// parse_slider_button


			//------------------------------------------------------------------
			//------------------------------------------------ parse_push_button
			//------------------------------------------------------------------
			function parse_push_button(telemetry){

				console.log		("push button: " + telemetry.name + " is: " + telemetry.state);
				show_push_button(telemetry.id, telemetry.name, telemetry.state);
			}// parse_push_button
			
			function validate_lightbar_config (format){
				if (format == pattern_format)
					return true;
				else 
					false;
			}

			//------------------------------------------------------------------
			//------------------------------------------------ parse_animation_list
			//------------------------------------------------------------------
			function parse_animation_list(animation) {
			        var anim = document.getElementById("animation_list");
				anim.length = 0; //ensuring length is 0. This is to take care when returning from another tab
				var anim_array = [];	
				anim_array = animation.animations;
				if (anim_array.length == 0)
					return;
				var indx = 0;
				var anim_indx = 0;
				for (;indx < anim_array.length;indx++)
				{
					try {
						var anim_ = JSON.parse(anim_array[indx]);
				        }
					catch(err) {
						console.log(err);
						continue;
					}
					var anim_name = anim_.animation;
					
					var format = anim_.lightbar_config; //lightbar configuration/composition
					//if format of animation doesn't match move to next animation
					if (!validate_lightbar_config (format))
						continue;
					anim.options[anim.options.length] = new Option(anim_name,anim_name);
					animation_array[anim_indx++] = anim_.patterns;
				}

				/*
				//sort the list in alphabetical order
				var tmpAry = new Array();
				for (var i=0;i<anim.options.length;i++) {
					tmpAry[i] = new Array();
					tmpAry[i][0] = anim.options[i].text;
					tmpAry[i][1] = anim.options[i].value;
				}
				tmpAry.sort();
				while (anim.options.length > 0) {
					anim.options[0] = null;
				}
				for (var i=0;i<tmpAry.length;i++) {
					var op = new Option(tmpAry[i][0], tmpAry[i][1]);
					anim.options[i] = op;
				}
				*/
			}
            
            function parse_lightbar_config (telemetry) {
		        var config                  = telemetry.Config;
			    pattern_format              = config.Configuration["lightbar_config"];
                var div_selected_animation  = document.getElementById("selected_animation_pattern");
                var div_create_animation    = document.getElementById ("create_animation");
                var div_config_pattern_params   = document.getElementById ("config_pattern_params");

   		        //get all animation
			    ws.send("get animation");

			    //create input objects to display LED brightness values
                //PJ - <TBD> revisit when individual pattern is replaced with pattern table
			    var led_array = pattern_format.split('-'); 
                var table = document.createElement ('table');
                var tr = document.createElement ('tr');
                for (var i=0;i <led_array.length;i++){
                    var td = document.createElement('td');
                    var hd = document.createTextNode(led_array[i]);
                    td.appendChild(hd);
                    td.setAttribute('align','center');
                    tr.appendChild(td);
                    tr.setAttribute('style','color:white;background-color:grey');

                }
                table.appendChild(tr);
                
                var tr = document.createElement ('tr');
                for (var i=0;i <led_array.length;i++)
                {
                    var td = document.createElement('td');
                    
				    var ip = document.createElement("input");
                    ip.setAttribute('type','number');
                    ip.setAttribute('style','width:2.5em;fontSize:50%');
                    ip.setAttribute('value','0');
                    ip.setAttribute('id','Led'+i.toString());
					ip.setAttribute('max',MAX_LED_INTENSITY);
					ip.setAttribute('min','0');
                    if (led_array[i] == 'N' || led_array[i] == 'n')
                        ip.setAttribute('disabled','true');
                        
                    td.appendChild(ip);
                    tr.appendChild(td);

                } 
                table.appendChild(tr);
                div_selected_animation.appendChild(table);
                div_selected_animation.setAttribute('style','width:800px;overflow:auto'); 

                /////////New animation/create pattern//////
                var table = document.createElement ('table');
                var tr = document.createElement ('tr');
                for (var i=0;i <led_array.length;i++){
                    var td = document.createElement('td');
                    var hd = document.createTextNode(led_array[i]);
                    td.appendChild(hd);
                    td.setAttribute('align','center');
                    tr.appendChild(td);
                    tr.setAttribute('style','color:white;background-color:grey');

                }
                table.appendChild(tr);


                var tr = document.createElement ('tr');
                for (var i = 0; i < led_array.length;i++)
                {
                    var td = document.createElement('td');

				    var ip = document.createElement("input");
				    ip.setAttribute('type','number');
				    ip.setAttribute('style','width:2.5em');
				    ip.setAttribute('value','0');
					ip.setAttribute('id','Pattern_Led'+i.toString());
					ip.setAttribute('max',MAX_LED_INTENSITY);
					ip.setAttribute('min','0');
                    if (led_array[i] == 'N' || led_array[i] == 'n')
                        ip.setAttribute('disabled','true');
                    td.appendChild(ip);
                    tr.appendChild(td);
				}
                table.appendChild(tr);
                div_create_animation.appendChild(table);
                div_create_animation.setAttribute('style','width:800px;overflow:auto');

					var lbl = document.createElement("Label");
					lbl.setAttribute ('for','active');
					lbl.innerHTML = 'Pattern Active Time:';
					div_config_pattern_params.appendChild(lbl);

					var active_time_input = document.createElement("input");
					active_time_input.setAttribute('type','number');
					active_time_input.setAttribute('id','active');
					active_time_input.setAttribute('style','width: 4em');
					active_time_input.setAttribute('value','0');
					active_time_input.setAttribute('min','0');
					active_time_input.setAttribute('max','9999');
					div_config_pattern_params.appendChild(active_time_input);

					lbl = document.createElement("Label");
					lbl.setAttribute ('for','pattern_name');
					lbl.innerHTML = 'Pattern Name:';
					div_config_pattern_params.appendChild(lbl);

					var animation_name_input = document.createElement("input");
					animation_name_input.setAttribute('type','text');
					animation_name_input.setAttribute('id','pattern_name');
					animation_name_input.setAttribute('style','width: 10em');
					animation_name_input.setAttribute('value','0');
					div_config_pattern_params.appendChild(animation_name_input);

					var btn_save_anim = document.createElement("button");
					btn_save_anim.setAttribute('style','auto');
					btn_save_anim.setAttribute('id','save_pattern_server');
					btn_save_anim.setAttribute('onclick','save_pattern_onserver()');
					btn_save_anim.innerHTML = 'Save';
					div_config_pattern_params.appendChild(btn_save_anim);
            }
		
			//------------------------------------------------------------------
			//------------------------------------------------parse_action_error 
			//------------------------------------------------------------------
			function parse_action_error(telemetry) {
			    var req_action = telemetry.action;
			    var error = telemetry.error;

			    switch(error)
			    {
				case 'duplicate':
				    alert('Animation already exists. Cannot create new animation');
				    break;

			    }

			}

			//------------------------------------------------------------------
			//-----------------------------------------------parse_action_sucess 
			//------------------------------------------------------------------
			function parse_action_success(telemetry) {
			    var req_action = telemetry.action;
			    var msg = telemetry.message;

			    switch(msg)
			    {
				case 'add animation':
				    alert('Animation added sucessfully!');
				    
                    //add to the list of available patterns. Assumption is pattern will be written on file successfully
				    var anim = document.getElementById("animation_list");
				    var anim_name = document.getElementById("animation_name");
				    anim.options[anim.options.length] = new Option(anim_name.value,anim_name.value);
			
				    animation_array[animation_array.length] = pattern_array_selected;
				    document.getElementById("animation_name").value = "";
				    break;

			    }
			}

			//------------------------------------------------------------------
			//-----------------------------------------------------openTab 
			//------------------------------------------------------------------
			function openTab(evt, cityName) {
			    var i, tabcontent, tablinks;
			    tabcontent = document.getElementsByClassName("tabcontent");
			    for (i = 0; i < tabcontent.length; i++) {
					tabcontent[i].style.display = "none";
			    }
			    tablinks = document.getElementsByClassName("tablinks");
			    for (i = 0; i < tablinks.length; i++) {
					tablinks[i].className = tablinks[i].className.replace(" active", "");
			    }
			    document.getElementById(cityName).style.display = "block";
			    evt.currentTarget.className += " active";
			    //get lightbar configuration, it should be selected by user but time being hard coded
                //ws.send( "get configuration,Configuration-demo.json," );
                ws.send( "get configuration,Configuration-Eddie.json," );

			    //get all animation
			    //ws.send("get animation");

			    ws.send('{"event":"cmd","type":"animation","action":"stop"}');
                            clear_led_strip();
			};

			//----------------------------------------------------------------
			//-------------------------------------pattern object constructor
			//---------------------------------------------------------------
			function pattern (name, time, pattern) {
			    this.name = name;
			    this.active_time = time;
			    this.pattern = pattern;

			    this.getPattern = function () {
				return this.pattern;
			    }

			    this.getActiveTime = function () {
				return this.active_time;
			    }
			};
			//----------------------------------------------------------------
			//----------------------------------------------------toggleCheck
			//---------------------------------------------------------------
			function toggleCheck () {
			    //check whole table, get checkbox state and reflect it on patter_array
			    var tab = document.getElementById("pattern_table");
			    var rows = tab.rows.length;
			    var selected_index = 0;
			    pattern_array_selected.length = 0;
			    for (var i = 0; i < rows ;i++)
			    {
			  	var chk_box = tab.rows[i].cells[0].firstChild.checked;
				if (chk_box)
				    pattern_array_selected[selected_index++] = pattern_array[i];

			    }
			};
            //------------------------------------------------------------------
            //--------------------------------------------insertRow 
            //------------------------------------------------------------------
			function insertRow(name,time) {

			    var tab = document.getElementById("pattern_table");
			    //var tabRow = tab.insertRow(tab.rows.length-1);
			    var tabRow = tab.insertRow(tab.rows.length);
			    var col1html = "<input type=\"checkbox\" checked onclick=\"toggleCheck ()\"/>";

                var col1 = tabRow.insertCell(0); col1.innerHTML=col1html;
			    var col2 = tabRow.insertCell(1); col2.innerHTML=name;
			    var col3 = tabRow.insertCell(2); col3.innerHTML=time;
			}

            //------------------------------------------------------------------
            //--------------------------------------------deleteAllRows 
            //------------------------------------------------------------------
			function deleteAllRows(name,time) {
			    var tab = document.getElementById("pattern_table");
                var rows = tab.rows.length; //get row count
                for (i = rows-1;i >= 0;i--)
                    tab.deleteRow(i); //delete row 
            }

			//------------------------------------------------------------------
			//--------------------------------------------save_pattern_onserver 
			//------------------------------------------------------------------
			function save_pattern_onserver() {
			    var active_time = document.getElementById("active");
			    var pattern_name = document.getElementById("pattern_name");
                            var letterNumber = /^[0-9a-zA-Z_/-]+$/;
			    if (!pattern_name.value.match(letterNumber))
			    {
				alert('Pattern name can contain alphanumeric values,- and _');
				return;
			    }

			    //PJ - commenting hardcoding of RGBW and prelace it with generic code
			    var led_array = pattern_format.split('-');
                var pattern_str = "";
			    for (var i=0;i < led_array.length-1;i++) {
					var led = 'Pattern_Led'+i.toString();
					pattern_str += document.getElementById(led).value;
					pattern_str += '-';
			    }
		   	    var led = 'Pattern_Led'+i.toString();
			    pattern_str += document.getElementById(led).value;
			    
			    var new_pattern 		= new pattern (pattern_name.value,active_time.value,pattern_str);
			    var pattern_index 		= pattern_array.length;
			    var duplicate_pattern 	= false;
			    for (;pattern_index >0 ; pattern_index--)
			    {
					if (pattern_name.value == pattern_array[pattern_index-1].name)
				    	duplicate_pattern = true;
			    }

			    if (!duplicate_pattern)
			    {
			        pattern_array.push(new_pattern);
			        pattern_array_selected.push(new_pattern);
			        //pattern_array.unshift(new_pattern);
			        insertRow(pattern_name.value,active_time.value);
			    }
			    else
					alert ('Duplicate pattern name');
                            //ws.send("save pattern," + msg+","); 
			    document.getElementById("pattern_name").value = "";
			};

			//------------------------------------------------------------------			
			//-------------------------------------------animate 
			//------------------------------------------------------------------
			function animate_pattern () {
			    //animate newly created animation, use checked patterns only
		        recur_set_pattern(0);

			};

			//------------------------------------------------------------------
			//--------------------------------------------recur_set_pattern 
			//------------------------------------------------------------------
			function recur_set_pattern(pattern_index)
			{
			    if (pattern_index < pattern_array_selected.length)
			    {
                    //var pattern_to_play = pattern_array[pattern_index-1];
                    var pattern_to_play = pattern_array_selected[pattern_index];
                    var pattern_str = pattern_to_play.getPattern();
                    var active_time = pattern_to_play.getActiveTime ();
                    var led_array = pattern_str.split("-");
                    //PJ - Need to correct logic of timeout, for time being it is what it is
                    set_led_strip(led_array);
				 	pattern_index = pattern_index + 1;
					setTimeout(recur_set_pattern,active_time,pattern_index);
			    }

			};
			//------------------------------------------------------------------
			//-----------------------------------------------clear_pattern_table
			//------------------------------------------------------------------
            function clear_pattern_table () {
                deleteAllRows();
                pattern_array.length = 0;
                pattern_array_selected.length = 0;
            }

			//------------------------------------------------------------------
			//--------------------------------------------save_animation_onserver
			//------------------------------------------------------------------
			function save_animation_onserver ()
			{
			    //create json data and send it to server for saving
			    var anim_name = document.getElementById("animation_name");
                            var letterNumber = /^[0-9a-zA-Z_/-]+$/;
			    if (!anim_name.value.match(letterNumber))
			    {
				alert('Animation name can contain alphanumeric values,- and _');
				return;
			    }
			    //var all_ptrn = {animation:anim_name.value,patterns:pattern_array_selected};
			    //PJ - added pattern_format for future use so that pattern created for one particular type of
			    //lightbar is not used and tool can support differt configuration of lightbar
			    var all_ptrn = {animation:anim_name.value,lightbar_config:pattern_format,patterns:pattern_array_selected};
			    var msg_str = JSON.stringify(all_ptrn);

			    //used & so that command "save animation" can be identified from the data string uniquely 
			    ws.send("save animation"+"&"+msg_str+"&");

			};
			//------------------------------------------------------------------
			//--------------------------------------------get_pattern_list 
			//------------------------------------------------------------------
                        function get_pattern_list() {
				console.log("get pattern");
				ws.send("get patterns");

			};

			//------------------------------------------------------------------
			//--------------------------------------------edit_animation 
			//------------------------------------------------------------------
			function edit_animation() {
				console.log("Edit Pattern");
				if (document.getElementById("edit_pattern").innerHTML == "Edit") {
				document.getElementById("pattern_list").disabled = false;
				document.getElementById("delete_pattern").disabled = true; //disable delete animation button
				document.getElementById("edit_pattern").innerHTML = "Undo";
				}
				else {
					document.getElementById("delete_pattern").disabled = false; //disable delete animation button
					document.getElementById("edit_pattern").innerHTML = "Edit";
				}
			};
 
			//------------------------------------------------------------------
			//----------------------------------------------------play_animation 
			//------------------------------------------------------------------
			function play_animation() {
				var anim = document.getElementById("animation_list");
				//need to send which animation to play but right now for POC default is enough
				ws.send ("play animation,"+anim.value+",");


			}

			//------------------------------------------------------------------
			//-------------------------------------------save_modified_animation 
			//------------------------------------------------------------------
			function save_modified_animation () {
				var anim = document.getElementById("animation_list");
				var pattern = document.getElementById("pattern_list");
				var animation = animation_array[anim.selectedIndex];
				var pattern_indx = pattern.selectedIndex;
				var mod_pattern = pattern_obj_array[pattern_indx];
				//create '-' separate led array
				var pattern_length = mod_pattern.pattern.split('-').length;
				mod_pattern.pattern = "";

				for (var i=0;i < (pattern_length-1);i++)
				{
				    //put this in try, this may fail
				    try 
				    {	
					//PJ - we may have to see if the value is valid, check valid values
				        mod_pattern.pattern += document.getElementById("Led"+i.toString()).value;    
					mod_pattern.pattern += '-';
 				    }
				    catch(err) {
					console.log(err);
				    }
				}
				//last value in array
				mod_pattern.pattern += document.getElementById("Led"+i.toString()).value;    

				mod_pattern.active_time = document.getElementById("active_time").value;
				pattern_obj_array[pattern_indx] = mod_pattern;	

				//create a new animation request/
			    var all_ptrn = {animation:anim.value,lightbar_config:pattern_format,patterns:pattern_obj_array};
			    var msg_str = JSON.stringify(all_ptrn);

			    //used & so that command "save animation" can be identified from the data string uniquely 
			    ws.send("save animation"+"&"+msg_str+"&");
			}

			//------------------------------------------------------------------
			//----------------------------------------------------delete_animation 
			//------------------------------------------------------------------
			function delete_animation () {
				var anim = document.getElementById("animation_list");
				var pattern = document.getElementById("pattern_list");
				var anim_name = anim[anim.selectedIndex].value;
				ws.send("delete animation,"+anim_name+",");
				animation_array.splice(anim.selectedIndex,1);
				anim.remove(anim.selectedIndex);
				pattern_obj_array.length = 0;
				var pattern_length = pattern.options.length;
				for (var i = (pattern_length-1); i >= 0;i--)
					pattern.remove(i);
			}

			//------------------------------------------------------------------
			//---------------------------------------------------- window.onload
			//------------------------------------------------------------------
			window.onload = function() {
				
				//--------------------------------------------------------------
				// get already create animation
				//--------------------------------------------------------------
				document.getElementById('animation_list').onchange = function (ev) {
					
					var selected_anim = document.getElementById("animation_list");
					var patterns = document.getElementById("pattern_list");
					patterns.options.length = 0; //flushing of pattern list empty
					//we may have to flush patterns before loading new patterns
					//need to correct logic below for finding right index
					var indx = selected_anim.selectedIndex;
					pattern_obj_array = animation_array[indx];
					//check for pattern validity -- review comment from discussion with jon/santosh
					var j = 0;
					for (var i =0;i < pattern_obj_array.length;i++)
					{
						var pattern_name = pattern_obj_array[i].name;
						patterns.options[patterns.options.length] = new Option(pattern_name,pattern_name);
					}
					
				}

				//--------------------------------------------------------------
				//Edit pattern, load led brightness and active time for a selected pattern 
				//--------------------------------------------------------------
				document.getElementById('pattern_list').onchange = function (ev) {
					var selected_pattern = document.getElementById("pattern_list");
					var indx = selected_pattern.selectedIndex;
					var pattern = pattern_obj_array[indx].pattern;
					var led_array = pattern.split('-');
					var a_time = pattern_obj_array[indx].active_time;
					//assign led valueds to each RGBW and active time for editing 
					//PJ - <TBD> need to replacd hard coded ids to dynamically created to get values
					for (var i=0;i< led_array.length;i++)
					{
						try {
						    document.getElementById("Led"+i.toString()).value = led_array[i];
						}
						catch(err) {
						    console.log(err);
						}
					}
					document.getElementById("active_time").value = a_time;
				}
				//--------------------------------------------------------------
				//------------------------------------- commands and telemetries
				//--------------------------------------------------------------
				document.getElementById('send_button').onclick = function(ev) {
					var msg = document.getElementById('send_input').value;
					document.getElementById('send_input').value = '';
					ws.send(msg);
				};// send_button.onclick

				document.getElementById('send_input').onkeypress = function(ev) {
					if (ev.keyCode == 13 || ev.which == 13) {
						document.getElementById('send_button').click();
					}
				};// send_input.onkeypress

				document.getElementById('send_button').onclick = function(ev) {
					var msg = document.getElementById('send_input').value;
					document.getElementById('send_input').value = '';
					ws.send(msg);
				};// send_button.onclick

				//--------------------------------------------------------------
				//------------------------------------------- moogoose animation
				//--------------------------------------------------------------
				document.getElementById('start_stop_mongoose_animation').onclick = function(ev) {
					if (this.textContent == "Start") {
						ws.send("start anim");
						this.textContent = "Stop";
					}
					else if (this.textContent == "Stop") {
						ws.send("stop anim");
						this.textContent = "Start";
						clear_led_strip();
					}
					else {
						console.error("unsupported mongoose animation button value: " + this.textContent);
					}
				};// start_stop_mongoose_animation.onclick

				document.getElementById('mongoose_animation_frame_rate').onchange = function(ev) {
					ws.send("set rate anim " + this.value);
				};// mongoose_animation_frame_rate.onchange

				//--------------------------------------------------------------
				//----------------------------------------- javascript animation
				//--------------------------------------------------------------
				document.getElementById('javascript_animation_frame_rate').onchange = function(ev) {
					set_javascript_animation_frame_rate(this.value);
				};// javascript_animation_frame_rate.onchange

				document.getElementById('start_stop_javascript_animation').onclick = function(ev) {
					var anim = document.getElementById('animation_list');
					if (this.textContent == "Start") {
						this.textContent = "Stop";
						start_javascript_animation(document.getElementById('javascript_animation_frame_rate').value,anim.value);
						//start_javascript_animation(document.getElementById('javascript_animation_frame_rate').value);
					}
					else if (this.textContent == "Stop") {
						this.textContent = "Start";
						stop_javascript_animation();
						clear_led_strip();
					}
					else {
						console.error("unsupported JavaScript animation button value: " + this.textContent);
						return;
					}

				};// start_stop_mongoose_animation.onclick

				//--------------------------------------------------------------
				//------------------------------------------- intrisic animation
				//--------------------------------------------------------------
				document.getElementById('start_stop_intrinsic_animation').onclick = function(ev) {
					if (this.textContent == "Start") {
						ws.send('{"event":"cmd","type":"animation","action":"resume"}');
						this.textContent = "Stop";
					}
					else if (this.textContent == "Stop") {
						ws.send('{"event":"cmd","type":"animation","action":"stop"}');
						this.textContent = "Start";
						clear_led_strip();
					}
					else {
						console.error("unsupported intrinsic animation button value: " + this.textContent);
					}
				}// start_stop_intrinsic_animation

				//--------------------------------------------------------------
				//---------------------------------------------------- led strip
				//--------------------------------------------------------------
				document.getElementById('clear_led_strip').onclick = function(ev) {
					clear_led_strip();
				}// clear_led_strip.onclick

				document.getElementById('set_led_strip').onclick = function(ev) {
					var left   = {red: parseInt(led_left_red  .value), green: parseInt(led_left_green  .value), blue: parseInt(led_left_blue  .value)};
					var right  = {red: parseInt(right_left_red.value), green: parseInt(right_left_green.value), blue: parseInt(right_left_blue.value)};
					var whites = new Uint16Array(NUMBER_OF_WHITE);

					whites[ 0] = W0 .value;
					whites[ 1] = W1 .value;
					whites[ 2] = W2 .value;
					whites[ 3] = W3 .value;
					whites[ 4] = W4 .value;
					whites[ 5] = W5 .value;
					whites[ 6] = W6 .value;
					whites[ 7] = W7 .value;
					whites[ 8] = W8 .value;
					whites[ 9] = W9 .value;
					whites[10] = W10.value;
					whites[11] = W11.value;
					whites[12] = W12.value;

					set_led_strip(left, right, whites);
				}// set_led_strip.onclick

				button_canvas  = document.getElementById('canvas_push_button');
				button_context = button_canvas.getContext('2d');
				button_font    = "bold " + "px serif";


			}// window.onload

			//------------------------------------------------------------------
			//-------------------------------------- document.onreadystatechange
			//------------------------------------------------------------------
			document.onreadystatechange = function(){
				if(document.readyState === 'complete'){
					initialize_javascript_animation();
				}
			}// document.onreadystatechange

	

			//------------------------------------------------------------------
			//-------------------------------------------------- window.onunload
			//------------------------------------------------------------------
			window.onunload = function() {
				uninitialize_javascript_animation();
			}// window.onunload

		</script>
	</head>

	<!--#####################################################################-->
	<!--################################################################ Body-->
	<!--#####################################################################-->
	<body>
		<div class="content">
			<h1 align="center">Lightbar Animation Tool</h1>

			<div class="tab">
			  <button class="tablinks" onclick="openTab(event, 'Animation')">Animation</button>
			  <!--<button class="tablinks" onclick="openTab(event, 'LightBar')">LightBar</button>-->
			</div>

			<div id="Animation" class="tabcontent">
				<p>
					<fieldset>
						<legend>View/Edit Animation</legend>
						<fieldset>
					            <legend>View Animation</legend>
                                                      <div id="view_animation">
							Available Animations <br>
							<select name="animation_list" id="animation_list" size=3 >
							</select>
							<br>
							<br>
							<!--<button style="width: auto" id="edit_pattern" onclick="edit_animation()">Edit</button>-->
							<button style="width: auto" id="play_pattern" onclick="play_animation()">Play</button>
							<button style="width: auto" id="save_pattern" onclick="save_modified_animation()">Save</button>
							<button style="width: auto" id="delete_pattern" onclick="delete_animation ()">Delete</button><br>
						      </div>
						</fieldset>	
						<fieldset >
					            <legend>Edit Animation Pattern</legend>
 						      <div id="edit_animation">
							<p>
								Patterns<br> 
								<select name="pattern_list" id="pattern_list" size=3 >
								</select>
							</p><br>
<!--
						<p>
							<label for="led_left_red">Left RGB:</label>
							<input type="number" id="led_left_red"	 style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
							<input type="number" id="led_left_green" style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
							<input type="number" id="led_left_blue"  style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
						</p>

						<p>
							<label for="right_left_red">Right RGB:</label>
							<input type="number" id="right_left_red"   style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
							<input type="number" id="right_left_green" style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
							<input type="number" id="right_left_blue"  style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
						</p>
						<p>
							<label for="W0">Whites:</label>
							<input type="number" id="W0"  style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
							<input type="number" id="W1"  style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
							<input type="number" id="W2"  style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
							<input type="number" id="W3"  style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
							<input type="number" id="W4"  style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
							<input type="number" id="W5"  style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
							<input type="number" id="W6"  style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
							<input type="number" id="W7"  style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
							<input type="number" id="W8"  style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
							<input type="number" id="W9"  style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
							<input type="number" id="W10" style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
							<input type="number" id="W11" style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
							<input type="number" id="W12" style="width: 4em" value="0" min="0" max=MAX_LED_INTENSITY />
						</p><br>
-->
                        <div styl='display:none' id="selected_animation_pattern">

                        </div>
						<p>
							<label for="Active time">Pattern Active Time:</label>
							<input type="text" id="active_time"  style="width: 4em"  value="0" pattern="[0-9]" />
						</p><br>
                        </div>
						</fieldset>
					</fieldset>
				</p>
				<p>
					<fieldset>
					    <legend>New Animation</legend>
					    <fieldset>
						<legend>Create Pattern</legend>
						<div id="create_animation">
						</div>
                        <div id="config_pattern_params">
                        </div>
					    </fieldset>
					    <fieldset>
						<legend>Create Animation</legend>
						<p>
						    <table cellspacing="0" cellpadding="0" border="0" width="325">
						      <tr>
						      <td>
						         <table cellspacing="0" cellpadding="1" border="1" width="300" >
							   <col width="50">
							   <col width="150">
							   <col width="100">
							   <tr style="color:white;background-color:grey">
							    <th>Add</th>
							    <th>Pattern Name</th>
							    <th>ActiveTime</th>
							   </tr>
						         </table>
						      </td>
						    </tr>
                                                    <tr>
                                                    <td>
						      <div style="width:300px; height:80px; overflow:auto;">
						        <table id="pattern_table" cellspacing="0" cellpadding="1" border="1" width="300" >
							   <col width="50">
							   <col width="150">
							   <col width="100">
							</table>
						      </div>
						    </td>
						  </tr>
						</table>
						</p><br>
						<p>
                            <div id='created_patterns_control'>
							<button style:"width :auto" id="play_animation" onclick="animate_pattern()">Animate</button>
							<button style:"width :auto" id="clear_table" onclick="clear_pattern_table()">Clear</button>
                            </div>
							<p>
                            <div id='input_save_animation'>
							<label for="Save Animation">Save Animation:</label>
							<input type="text" id="animation_name"  style="width: 10em" pattern="[A-Za-z0-9_\-]{255}" />
							<button style:"width :auto" id="save_animation_server" onclick="save_animation_onserver()">Save Animation</button>
                            </div>
							</p>
						</p>
					    </fieldset>
					</fieldset>

				</p>
			</p>
		</div>
	</body>
</html>
