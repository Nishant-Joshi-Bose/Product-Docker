#!/usr/bin/env groovy
/*
  Description: Jenkinsfile is a container for the pipeline script.
               Runs tests against a given branch in CastleSAAS repostiory
*/

def buildJob(jobName)
{
   build job: jobName , parameters: [[$class: 'GitParameterValue', name: 'Branch', value: "${env.CHANGE_BRANCH}"]]
}

/*
Below are the jobs list to run against each PR.
*/

def ProductContinousTest         = ["Continous_Build_Testing/CastleProduct_Continuous_Build_Testing_Master_PR"]

failureList = []

def executeBuild(item){
    try
    {
        buildJob(item)
        echo 'Current Build set to SUCCESS'
    }
    catch (Exception ex)
    {
        echo "Caught: ${ex}"
        failureList.add(item)
        echo 'Current Build set to FAILURE'
    }
}

timeout(time: 4, unit: 'HOURS')
{
  node('eco2-pipeline-container')
    {
      try
       {
        parallel(
            "stream 1 (ProductContinousTest)" :{
                 stage("ProductContinousTest")
                 {
                    for (item in ProductContinousTest)
                    {
                        try
                        {
                            executeBuild(item)
                        }
                        catch (Exception ex)
                        {
                            echo "Caught: ${ex}"
                        }
                        continue
                     }
                 }
             }
         )
       }
     catch (e)
       {
           currentBuild.result = 'FAILURE'
           throw e
       }
    finally
      {
          currentBuild.description = "${failureList}"
          if(failureList){
              currentBuild.result = 'FAILURE'
          }
          else{
              currentBuild.result = 'SUCCESS'
          }
      }
    }
}
