#!/usr/bin/python2.7
#
# Validate the manufacturing data to make sure it contains the information the
# SoundTouch daemons require.  If invalid, show how to fix it.
#
# See also:
# https://wiki.bose.com/display/BC/Riviera+Manufacturing+Data+Information
#
import sys
import os
import subprocess
import re

this_script = os.path.basename(sys.argv.pop(0))

if len(sys.argv) > 1:
    raise Exception("wrong usage")

def warn(*args):
    print >>sys.stderr, this_script + ":", " ".join(map(lambda a: str(a), args))

devnull = open(os.devnull, "w")

def get(name):
    """Get the mfgdata value associated with NAME"""
    ph = subprocess.Popen(["mfgdata", "get", name],
                          stdout=subprocess.PIPE, stderr=devnull)
    out = ph.stdout.read()
    if ph.wait() != 0:
        return None
    return out.rstrip("\n")

fixes = []

# "modified" is always present ordinarily.  If missing, means there's no
# manufacturing data at all or it's malformed/corrupt.
if get("modified") is None:
    warn("Manufacturing data is missing or invalid")
    fixes.append("clear")

# 'development' is optional, but if present must be "true" or "false"
optional_dev = True
dev = get("development")
if dev is not None and dev != "true" and dev != "false":
    warn("development field is invalid:", dev)
    fixes.append("set development true")
    optional_dev = False

cc = get("country_code")
if cc is None or not re.match(r'^[A-Z][A-Z]$', cc):
    warn("Invalid country_code", cc)
    fixes.append("set country_code US")

rc = get("regionCode")
if rc is None or not re.match(r'^[A-Z][A-Z]$', rc):
    warn("Invalid regionCode", rc)
    fixes.append("set regionCode US")

# GUID standard canonical form is described here:
# https://en.m.wikipedia.org/wiki/Universally_unique_identifier
guid = get("guid")
if guid is None or not re.match(r'^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$', guid):
    warn("Invalid guid:", guid)
    guid = open("/proc/sys/kernel/random/uuid").read().rstrip("\n")
    fixes.append("set guid " + guid)

sn = get("snSystem")
if not sn: # allow any non-empty string
    warn("Invalid snSystem:", sn)
    fixes.append("set snSystem RF000000000000000")

pc = get("productColor")
if not pc:
    warn("productColor not set:", pc)
    fixes.append("set productColor BLACK")

vi = get("BMAPVariantID")
if vi is None or not re.match(r'^\d+$', vi):
    warn("Invalid BMAPVariantID should be a number:", vi)
    fixes.append("set BMAPVariantID 2")

pn = get("productName")
if not pn: # allow any non-empty string
    warn("Invalid productName:", sn)
    fixes.append("set productName 'Bose Home Speaker 500'")

pt = get("productType")
if not pt: # allow any non-empty string
    warn("Invalid productType:", sn)
    fixes.append("set productType Eddie")

if not fixes:
    # Validation successful.
    sys.exit()

if optional_dev:
    fixes.append("set development true # (optional)")

print """
To set manufacturing data:

  mount -oremount,rw /persist"""
for fix in fixes:
    print "  mfgdata", fix
print """\
  mount -oremount,ro /persist
"""
sys.exit(1)
