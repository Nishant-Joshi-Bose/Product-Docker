#!/bin/bash
#
# Start/stop shepherdd, the SoundTouch meta-daemon.
#
export PATH=/opt/Bose/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin
tag="${0##*/}[$$]"              # for log messages

/opt/Bose/webkit/target_scripts/lcd/init-lcd.sh

function log {
    local pri="$1"; shift
    logger -s -t "$tag" -p "$pri" "$*"
}

cd /opt/Bose/bin || exit

rundir=/var/run/shepherd
override=false

# For testing, make it easy to override what shepherd config files we use.
if [ -d /mnt/nv/shepherd ]; then
    rundir=/mnt/nv/shepherd
    override=true
fi

if (( $# >= 1 )) && [ "$1" = start ]; then
    shift

    log info "* Starting SoundTouch *"

    # By default we launch shepherdd into the background (as expected by
    # /etc/init.d).  With --wait we instead invoke sheppherd and wait for it
    # to exit (preferred by systemd).
    wait=false
    if (( $# > 0 )) && [ "$1" = --wait ]; then
        shift
        wait=true
    fi

    if pid=$(pgrep shepherdd); then
        log warning "shepherdd is already running, PID $pid"
        kill -HUP "$pid" # ask shepherdd to re-examine $rundir
        exit 1
    fi

    if ! mfgdata get country_code >/dev/null; then
        log warning "Missing or invalid manufacturing data, won't start SoundTouch"
        cat >&2 <<\EOF
To set manufacturing data:

  mount -oremount,rw /persist
  mfgdata clear
  mfgdata set development true
  mfgdata set country_code US
  mount -oremount,ro /persist

EOF
        exit 1
    fi

    if ! is-development; then
        set -- "$@" --recovery
        ulimit -c 0
        log info "Production mode (core files disabled, recovery enabled)"
    else
        ulimit -c unlimited
        log info "Development mode (core files enabled, recovery disabled)"
        echo "|/opt/Bose/etc/store-core %e-%u-%g-%p-%t-%s" > \
            /proc/sys/kernel/core_pattern
    fi

    if ! [ -e /mnt/nv/BoseLog ]; then
        ln -s /data/logs /mnt/nv/BoseLog
    fi
    clean_logs
    mkdir -p /mnt/nv/IoTCerts /mnt/nv/BoseApp-Persistence/1 /mnt/nv/product-persistence

    rw --read-only

    set_ap.sh

    demoFlag=/mnt/nv/DemoModeOn
    if ! $override; then
        mkdir -p "$rundir" || exit
        rm -f "$rundir"/*.xml
        ln -s /opt/Bose/etc/Shepherd*.xml "$rundir" || exit
        if [ -e "$demoFlag" ]; then
            log info "--DEMO MODE--"
            ln -nsf /opt/Bose/etc/KeyConfiguration-demo.json  "$rundir"/KeyConfiguration.json
        else
            ln -nsf /opt/Bose/etc/KeyConfiguration.json       "$rundir"/KeyConfiguration.json
        fi

        if is-development; then
            cat >"$rundir/Debug.xml" <<\EOF
<ShepherdConfig>
  <daemon name="Telnet"
          exe="/sbin/telnetd">
    <arg>-l/bin/bash</arg>
    <arg>-S</arg> <!-- log to syslog -->
    <arg>-F</arg> <!-- run in foreground -->
  </daemon>
  <daemon name="Telemetry"
          exe="/opt/Bose/Telemetry/telemetry">
  </daemon>
</ShepherdConfig>
EOF
        fi
    fi

    set -- ./shepherdd "$@" "$rundir"
    log info "Starting $*"

    if $wait; then
        exec "$@"
    fi
    "$@" &
    exit 0
fi

if (( $# == 1 )) && [ "$1" = stop ]; then
    if ! pid=$(pgrep shepherdd); then
        log warning "shepherdd was not running"
        exit 1
    fi
    log info "Stopping shepherdd"
    kill "$pid"
    i=0
    while [ "$(sleep 1; cat 2>/dev/null "/proc/$pid/comm")" = shepherdd ]; do
        if (( ( i += 1 ) >= 30 )); then
            log warning "giving up, shepherdd is still running, PID $pid"
            exit 1
        fi
    done
    exit 0
fi

if (( $# >= 1 )) && [ "$1" = restart ]; then
    shift
    "$0" stop
    exec "$0" start "$@"
fi

if (( $# == 1 )) && [ "$1" = status ]; then
    # shepherdd will show the current status of the daemons
    # on the console and in logread.
    pkill -ALRM shepherdd
    exit
fi

echo >&2 "\
usage: $0 start [args...]
   or: $0 stop
   or: $0 restart
   or: $0 status
"
exit 1
