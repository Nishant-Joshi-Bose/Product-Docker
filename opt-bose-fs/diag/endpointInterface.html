<!--
    This file is intended to serve as a template page for QA CGI scripts that require access to a frontdoor endpoint.

    All of the information necessary for using the correct endpoint should be added by substituting the placeholder 
    variable CONFIGURATION_JSON_OBJECT with an actual JSON object in the following format:

    {
        "pageName": "Accessories",
        "endpoint": "/accessories",
        "fields": ["body.enabled","body.pairing",],
        "button":
        {
            "enabled": false,
            "name": "Start Pairing",
            "putData":
            {
                "pairing": true
            }
        }
    }

    See existing scripts for an example of proper usage and implementation.
-->

<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <title>Diagnostics</title>
        <style type="text/css">
            body {
                font-family: Verdana, Arial, Helvetica, sans-serif;
            }
            hr {
                border: 1px solid blue;
                color: #fff;
                background-color: #fff;
                height: 1px;
                width: 100%;
            }
            div.box {
                background-color: lightgrey;
                white-space: pre-wrap;
                border: thin dotted;
                padding: 1em;
                margin: 1em;
                max-height: 40em;
                overflow: scroll;
            }
            div.error{
                background-color: #FFCCCC;
                border: thin dotted;
                padding: 1em;
                margin: 1em;
                display: none;
                white-space: pre-line;
            }
            td.showimg {
                padding: 8px;
            }
            input {
                display: none;
            }
        </style>
    </head>

    <body>
        <h1 id='header'>HEADER</h1>
        <hr>
        <li>FrontDoor Endpoint
        <div id='error-panel' class='error'>Unable to Connect to Device via Secured Web Sockets.

            This may be caused by an issue with the certificate used by the device. 
            To resolve this, navigate to <a id='security-host'>the websocket address</a> and add a security exception.


            Alternatively, you can start Google Chrome with the following arguments to disable certificate verification: 
                --ignore-certificate-errors --disable-web-security --user-data-dir

            On Windows: <code>"C:\Program Files (x86)\Google\Chrome\Application\chrome.exe‚Äù --ignore-certificate-errors --disable-web-security --user-data-dir</code>
            On Mac OS X: <code>/Applications/Google\ Chrome/Contents/MacOS/Google\ Chrome --args --ignore-certificate-errors --disable-web-security --user-data-dir</code>
            On Linux: <code>google-chrome --ignore-certificate-errors --disable-web-security --user-data-dir</code>
        </div>
        <div id='general-output-panel' class='box'></div>
        <input id='submit-payload-button' type='submit' value='GENERIC' class='submit btn waves-effect waves-light '/>
        <hr>
    </body>

    <footer>
        <script type="text/javascript">

            //Configuration placeholder for JSON object. See header comment. 
            var Configuration = $CONFIGURATION_JSON_OBJECT$ ;

            //Fill in parts of the HTML with information from JavaScript
            function PageConfiguration()
            {
                document.title = Configuration.pageName + " Diagnostics";
                document.getElementById('header').textContent = Configuration.pageName;
                document.getElementById('security-host').href = "https://" + window.location.hostname + ":8082/"
                document.getElementById('security-host').textContent = "https://" + window.location.hostname + ":8082/"
            }

            //Helper function to go through the nested JSON object(s) and return just the requested field
            function FindField(object,field)
            {
                field = field.split('.');
                while (field.length>1)
                {
                    object = object[field[0]];
                    field.shift();
                }
                return object[field[0]];
            }

            //WebSocketConnection to FrontDoor on the device
            function WebSocketConnection()
            {
                //Define websocket address based on page host, and connect with eco2 protocol
                var FrontDoorHost = "wss://"+window.location.hostname+":8082";
                var socket = new WebSocket(FrontDoorHost, "eco2");

                //Create variables for oft accessed HTML elements
                var errorPanel = document.getElementById('error-panel');
                var generalOutputTextAreaElem = document.getElementById('general-output-panel');

                //If button enabled in configuration, setup variable and unhide HTML element
                if (Configuration.button.enabled)
                {
                    var sendButton =  document.getElementById("submit-payload-button");

                    sendButton.value = Configuration.button.name;
                    sendButton.addEventListener("click", PutData);
                    sendButton.style.display = "block" ;
                }

                //On Connection to WebSocket, request system info to establish frontdoor communication
                socket.onopen = function()
                {
                    var sendObj = Message;
                    sendObj.header.resource='/system/info';
                    SendMessage(sendObj);
                    GetData();
                };

                //On receiving data back from FrontDoor
                socket.onmessage = function (evt)
                {
                    //Parse and log message
                    var received_msg = evt.data;
                    var msg = JSON.parse(received_msg);
                    console.log("Incoming:\n"+JSON.stringify(msg));

                    //If message is from endpoint of interest, add a timestamp to the message and output the needed fields to the HTML text area
                    if (msg.header.resource === Configuration.endpoint)
                    {
                        var output = (new Date().toLocaleTimeString()) + ": " + "\n";
                        Configuration.fields.forEach(function(att){

                            var value = FindField(msg, att);
                            output = output + att.split('.').pop() +": "+ JSON.stringify(value, null, 4) + "\n";  
                        });
                        generalOutputTextAreaElem.textContent = output + "\n\n" + generalOutputTextAreaElem.textContent;
                    }

                };

                //On Connection to WebSocket lost, log disconnection data and display a message to the user.
                socket.onclose = function(evt)
                {
                    console.log(evt);   

                    generalOutputTextAreaElem.textContent = (new Date().toLocaleTimeString()) + ": " + "\n WebSocket Connection Lost..." + "\n\n" + generalOutputTextAreaElem.textContent;
                };

                //On WebSocket connection error, log data and display an error message to the user
                socket.onerror = function(evt)
                {
                    console.log(evt);

                    errorPanel.style.display = "block" ;
                    generalOutputTextAreaElem.style.display = "none";
                };

                //before unloading the page, disconnect websocket.
                window.onbeforeunload = function(event)
                {
                    socket.close();
                };

                //Helper function for sending PUT frontdoor messages based on button configuration
                function PutData()
                {
                    sendObj=Message;

                    sendObj.header.reqID++;
                    sendObj.header.resource=Configuration.endpoint;
                    sendObj.header.method="PUT";
                    sendObj.body = Configuration.button.putData;

                    SendMessage(sendObj);
                }

                //Helper function for sending GET frontdoor messages
                function GetData()
                {
                    sendObj=Message;

                    sendObj.header.reqID++;
                    sendObj.header.resource=Configuration.endpoint;
                    sendObj.header.method="GET";

                    SendMessage(sendObj);
                }

                //Helper function for sending messages over the WebSocket Connection
                function SendMessage(message)
                {
                    try{
                        //Convert message to JSON, log to console, and send over WebSocket
                        sendStr = JSON.stringify(message);
                        console.log("Outgoing \n"+sendStr);
                        socket.send(sendStr);
                    }

                    catch(e) {
                        //Log error to if message couldn't be sent. 
                        console.log("Couldn't send message: " + sendStr);
                    }
                }
            }

            //FrontDoor Message template
            var Message = {
                "header":{
                    "resource":"",
                    "version":1,
                    "token":"",
                    "method":"GET",
                    "device":"",
                    "reqID":1,
                    "msgtype":"REQUEST"
                }
            }
            PageConfiguration();
            WebSocketConnection();
        </script>
    </footer>

</html>
